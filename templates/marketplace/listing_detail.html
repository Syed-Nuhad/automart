{% extends "base.html" %}{% load static %}
{% block title %}{{ listing.title }}{% endblock %}

{% block content %}
<div class="container py-3">

  {# Unpublished notice #}
  {% if not listing.is_published %}
    <div class="alert alert-warning d-flex align-items-center gap-2 mb-3">
      <i class="bi bi-exclamation-triangle"></i>
      <div>This listing is visible only to you until it’s approved.</div>
    </div>
  {% endif %}

  {# Cover / Hero #}
  {% with cover=listing.photos.all|first %}
    <div class="rounded-3 overflow-hidden mb-3 position-relative">
      <div class="ratio ratio-21x9">
        {% if cover %}
          <img src="{{ cover.image.url }}" class="w-100 h-100 object-fit-cover" alt="{{ cover.alt_text|default:listing.title }}">
        {% else %}
          <div class="w-100 h-100 bg-gradient" style="--bs-gradient:linear-gradient(120deg,#0d6efd,#6610f2);background:var(--bs-gradient)"></div>
        {% endif %}
      </div>
      <div class="position-absolute top-0 start-0 w-100 h-100"
           style="background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.55));"></div>
      <div class="position-absolute bottom-0 start-0 end-0 p-3 p-md-4 text-white">
        <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2">
          <div>
            <h1 class="h3 mb-1">{{ listing.title }}</h1>
            <div class="small opacity-75">
              {{ listing.make }} {{ listing.model }} • {{ listing.year }} • {{ listing.mileage_km }} km • {{ listing.location }}
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge rounded-pill text-bg-primary">{{ listing.fuel_type|capfirst }}</span>
            <span class="badge rounded-pill text-bg-secondary">{{ listing.transmission|capfirst }}</span>
            <span class="badge rounded-pill text-bg-success">{{ listing.condition|capfirst }}</span>
          </div>
        </div>
      </div>
    </div>
  {% endwith %}

  {# Actions #}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="display-6 fw-bold text-primary m-0">৳ {{ listing.price }}</div>

    <div class="d-flex flex-wrap gap-2">
      {% if user.is_authenticated and user.id == listing.seller_id %}
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'marketplace:edit_listing' listing.slug %}">
          <i class="bi bi-pencil"></i> Edit
        </a>
        <a class="btn btn-outline-danger btn-sm" href="{% url 'marketplace:delete_listing' listing.slug %}">
          <i class="bi bi-trash"></i> Delete
        </a>
      {% endif %}

      {% if user.is_staff %}
        <form method="post" action="{% url 'marketplace:toggle_publish' listing.slug %}">
          {% csrf_token %}
          {% if listing.is_published %}
            <button class="btn btn-warning btn-sm" type="submit">
              <i class="bi bi-eye-slash"></i> Unpublish
            </button>
          {% else %}
            <button class="btn btn-success btn-sm" type="submit">
              <i class="bi bi-check2-circle"></i> Publish
            </button>
          {% endif %}
        </form>
      {% endif %}
    </div>
  </div>

  <div class="row g-4">
    {# Gallery #}
    <div class="col-lg-7">
      {% if listing.photos.all %}
        <div class="row g-3">
          {% for p in listing.photos.all %}
            <div class="col-6 col-md-4">
              <div class="ratio ratio-4x3 rounded-3 overflow-hidden border">
                <img src="{{ p.image.url }}" class="w-100 h-100 object-fit-cover" alt="{{ p.alt_text|default:listing.title }}">
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="ratio ratio-16x9 bg-light border rounded-3 d-flex align-items-center justify-content-center">
          <div class="text-muted"><i class="bi bi-image me-1"></i>No photos uploaded</div>
        </div>
      {% endif %}
    </div>

    {# Sticky spec / contact card #}
    <div class="col-lg-5">
      <div class="card shadow-sm border-0 rounded-3 position-sticky" style="top: 1rem;">
        <div class="card-body">
          <h2 class="h5 mb-3">Specifications</h2>
          <div class="row row-cols-2 g-2 small">
            <div><span class="text-muted">Make</span><br><span class="fw-semibold">{{ listing.make }}</span></div>
            <div><span class="text-muted">Model</span><br><span class="fw-semibold">{{ listing.model }}</span></div>
            <div><span class="text-muted">Year</span><br><span class="fw-semibold">{{ listing.year }}</span></div>
            <div><span class="text-muted">Mileage</span><br><span class="fw-semibold">{{ listing.mileage_km }} km</span></div>
            <div><span class="text-muted">Fuel</span><br><span class="fw-semibold">{{ listing.fuel_type|capfirst }}</span></div>
            <div><span class="text-muted">Transmission</span><br><span class="fw-semibold">{{ listing.transmission|capfirst }}</span></div>
            <div><span class="text-muted">Condition</span><br><span class="fw-semibold">{{ listing.condition|capfirst }}</span></div>
            <div><span class="text-muted">Location</span><br><span class="fw-semibold">{{ listing.location }}</span></div>
          </div>

          <hr class="my-3">

          <h3 class="h6 mb-2">Contact seller</h3>
          <div class="d-flex flex-column gap-2">
            {% if listing.contact_phone %}
              <a class="btn btn-outline-primary btn-sm" href="tel:{{ listing.contact_phone }}">
                <i class="bi bi-telephone"></i> {{ listing.contact_phone }}
              </a>
            {% endif %}
            {% if listing.contact_email %}
              <a class="btn btn-outline-secondary btn-sm" href="mailto:{{ listing.contact_email }}">
                <i class="bi bi-envelope"></i> {{ listing.contact_email }}
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Description #}
  {% if listing.description %}
    <div class="card shadow-sm border-0 rounded-3 mt-4">
      <div class="card-body">
        <h2 class="h5 mb-2">Description</h2>
        <div class="text-secondary">{{ listing.description|linebreaks }}</div>
      </div>
    </div>
  {% endif %}

</div>

{# Tiny helpers #}
<style>
  .object-fit-cover { object-fit: cover; }
  .bg-gradient { background: linear-gradient(120deg,#0d6efd,#6610f2); }
</style>
{% endblock %}
