{% extends "base.html" %}
{% block title %}Dealer Map{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Dealer Map</h1>
  </div>

  <!-- The #1 reason for a blank map is ZERO HEIGHT: give it a height -->
  <div id="dealer-map" class="rounded border" style="height: 70vh; min-height: 420px; overflow: hidden;"></div>

  <div id="dealerMapMsg" class="small text-muted mt-2"></div>
</div>
{% endblock %}

{% block extra_script %}


<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('dealer-map');
  if (!el) return;
  if (!window.L) { console.error('Leaflet not loaded'); return; }

  const map = L.map(el, { zoomControl: true }).setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
  }).addTo(map);

  const cluster = L.markerClusterGroup();
  const esc = s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));

  fetch('/api/dealers/')
    .then(r => r.json())
    .then(fc => {
      const bounds = [];
      (fc.features || []).forEach(f => {
        const [lng, lat] = (f.geometry && f.geometry.coordinates) || [];
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const p = f.properties || {};
        const popup = `
          <div class="small">
            <strong>${esc(p.name)}</strong><br>
            ${esc(p.address || '')}<br>
            ${p.phone ? `<a href="tel:${esc(p.phone)}">${esc(p.phone)}</a><br>` : ''}
            ${p.website ? `<a href="${esc(p.website)}" target="_blank" rel="noopener">Website</a><br>` : ''}
            ${p.url ? `<a href="${esc(p.url)}">View dealer</a>` : ''}
          </div>`;
        cluster.addLayer(L.marker([lat, lng]).bindPopup(popup, { maxWidth: 260 }));
        bounds.push([lat, lng]);
      });
      map.addLayer(cluster);
      if (bounds.length) map.fitBounds(bounds, { padding: [24, 24] });
    })
    .catch(err => console.error('Dealer map load failed:', err));
});
</script>
{% endblock %}
