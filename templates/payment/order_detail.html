{# templates/payment/order_detail.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  {# -------- Header -------- #}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1">Order {{ order.display_number|default_if_none:"#?" }}</h1>
      <div class="text-muted small">
        Placed: {{ order.created_at|date:"Y-m-d H:i" }}
        {% if order.paid_at %} · Paid: {{ order.paid_at|date:"Y-m-d H:i" }}{% endif %}
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      {% with s=order.status %}
        <span class="badge
          {% if s == 'paid' %}bg-success
          {% elif s == 'pending' %}bg-warning text-dark
          {% elif s == 'canceled' %}bg-secondary
          {% else %}bg-danger{% endif %}">
          {{ s|title }}
        </span>
      {% endwith %}
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'order_list' %}">
        <i class="bi bi-arrow-left"></i> Back to orders
      </a>
      <button class="btn btn-primary btn-sm" onclick="window.print()">
        <i class="bi bi-printer"></i> Print
      </button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header"><strong>Items</strong></div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th class="text-center" style="width: 90px;">Qty</th>
                  <th class="text-end" style="width: 160px;">Unit</th>
                  <th class="text-end" style="width: 160px;">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for it in order.items.all %}
                  <tr>
                    <td>{{ it.product_name }}</td>
                    <td class="text-center">{{ it.quantity }}</td>
                    <td class="text-end">
                      {% with c=it.unit_amount|stringformat:"02d" %}
                        {{ order.currency|upper }} {{ c|slice:":-2"|default:"0" }}.{{ c|slice:"-2:" }}
                      {% endwith %}
                    </td>
                    <td class="text-end">
                      {% with c=it.subtotal|stringformat:"02d" %}
                        {{ order.currency|upper }} {{ c|slice:":-2"|default:"0" }}.{{ c|slice:"-2:" }}
                      {% endwith %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center text-muted py-4">No items.</td></tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th colspan="3" class="text-end">Order total</th>
                  <th class="text-end">
                    {% with c=order.total_amount|stringformat:"02d" %}
                      {{ order.currency|upper }} {{ c|slice:":-2"|default:"0" }}.{{ c|slice:"-2:" }}
                    {% endwith %}
                  </th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-shield-check"></i>
          <span>Payment Evidence</span>
        </div>
        <div class="card-body small">
          <dl class="row mb-0">
            <dt class="col-5 text-muted">Status</dt>
            <dd class="col-7">{{ order.status|title }}</dd>

            <dt class="col-5 text-muted">Paid at</dt>
            <dd class="col-7">{% if order.paid_at %}{{ order.paid_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</dd>

            <dt class="col-5 text-muted">PayPal Order</dt>
            <dd class="col-7">{{ order.external_id|default:"—" }}</dd>

            <dt class="col-5 text-muted">Capture ID</dt>
            <dd class="col-7">{{ order.paypal_capture_id|default:"—" }}</dd>

            <dt class="col-5 text-muted">Payer ID</dt>
            <dd class="col-7">{{ order.payer_id|default:"—" }}</dd>

            <dt class="col-5 text-muted">Payer Email</dt>
            <dd class="col-7">{{ order.payer_email|default:"—" }}</dd>
          </dl>

          {% if order.gateway_response %}
            <details class="mt-3">
              <summary class="text-muted">Raw gateway JSON</summary>
              <pre class="mt-2 mb-0 small bg-light p-2 rounded border">{{ order.gateway_response }}</pre>
            </details>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
