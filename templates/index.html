{# templates/home.html #}
{% extends "base.html" %}
{% load static %}
{% load seller_badge %}
{% load i18n %}

{% block title %}{% trans "Home – AutoMart" %}{% endblock %}

{% block content %}

<!-- ============================== HERO / PRIMARY SEARCH (Admin-driven Carousel) ============================== -->
<section class="hero-section position-relative overflow-hidden">
  <!-- Background Carousel (images managed in Django admin via HeroSlide) -->
  <div id="heroCarousel"
       class="carousel slide carousel-fade position-absolute top-0 start-0 w-100 h-100 z-n1"
       data-bs-ride="carousel"
       data-bs-interval="4000"
       data-bs-wrap="true"
       aria-label="{% trans 'Hero background carousel' %}">
    <div class="carousel-inner h-100">
      {% for slide in hero_slides %}
        <div class="carousel-item h-100 {% if forloop.first %}active{% endif %}">
          <img src="{{ slide.image.url }}" class="d-block w-100 h-100 object-fit-cover" alt="{% blocktrans with n=forloop.counter %}Hero slide {{ n }}{% endblocktrans %}">
        </div>
      {% empty %}
        <!-- Fallback image if no slides exist -->
        <div class="carousel-item active h-100">
          <img src="{% static 'img/pexels-photo-358070.jpeg' %}" class="d-block w-100 h-100 object-fit-cover" alt="{% trans 'Default hero' %}">
        </div>
      {% endfor %}
    </div>

    {% if hero_slides|length > 1 %}
      <!-- Indicators -->
      <div class="carousel-indicators mb-4">
        {% for slide in hero_slides %}
          <button type="button"
                  data-bs-target="#heroCarousel"
                  data-bs-slide-to="{{ forloop.counter0 }}"
                  class="{% if forloop.first %}active{% endif %}"
                  aria-label="{% blocktrans with n=forloop.counter %}Slide {{ n }}{% endblocktrans %}"
                  {% if forloop.first %}aria-current="true"{% endif %}></button>
        {% endfor %}
      </div>

      <!-- Controls -->
      <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev" aria-label="{% trans 'Previous slide' %}">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next" aria-label="{% trans 'Next slide' %}">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
      </button>
    {% endif %}
  </div>

  <!-- Dark overlay for readability -->
  <div class="position-absolute top-0 start-0 w-100 h-100" style="background: rgba(0,0,0,0.55); z-index:0;"></div>

  <!-- Foreground content -->
  <div class="container position-relative py-5" style="z-index:1;">
    <div class="row align-items-center g-4">
      <!-- Left: Heading + chips + actions -->
      <div class="col-lg-6 text-white">
        <h1 class="display-5 fw-bold mb-3">{% trans "Find your next car with confidence." %}</h1>
        <p class="lead text-white">{% trans "Search thousands of verified listings, compare specs, and get financing—all in one place." %}</p>

        <!-- ============================== QUICK CHIPS ============================== -->
        <div class="d-flex flex-wrap gap-2 mt-3">
          {% if quick_chips %}
            {% for chip in quick_chips %}
              <span class="badge rounded-pill wf-pill text-white">
                {{ chip.title }} {# DB text; translate in DB or via taxonomy if needed #}
              </span>
            {% endfor %}
          {% else %}
            <span class="badge rounded-pill wf-pill text-white">{% trans "New arrivals" %}</span>
            <span class="badge rounded-pill wf-pill text-white">{% trans "Certified" %}</span>
            <span class="badge rounded-pill wf-pill text-white">{% trans "Under $20k" %}</span>
            <span class="badge rounded-pill wf-pill text-white">{% trans "SUV" %}</span>
            <span class="badge rounded-pill wf-pill text-white">{% trans "Electric" %}</span>
          {% endif %}
        </div>

        <div class="mt-4 d-flex gap-2">
          <a class="btn btn-primary" href="{% url 'home' %}#results">
            <i class="bi bi-lightning-charge me-1"></i> {% trans "Browse Deals" %}
          </a>
          <button class="btn btn-outline-light" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
            <i class="bi bi-sliders me-1"></i> {% trans "Filters" %}
          </button>
        </div>
      </div>

    </div>
  </div>
</section>


{# ============================== FEATURED ============================== #}
<section class="py-5">
  <div class="container">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="h4 mb-0">{% trans "Featured Deals" %}</h2>
      <a href="{% url 'home' %}" class="btn btn-sm btn-soft btn-pill btn-soft-primary">
        <i class="bi bi-lightning-charge me-1"></i> {% trans "View all" %}
      </a>
    </div>



    {% if featured_cars|length > 4 %}
      {# ===== Carousel mode (more than 4) ===== #}
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
      <div class="position-relative">
        <div id="featuredSwiper" class="swiper">
          <div class="swiper-wrapper">
            {% for car in featured_cars %}
              <div class="swiper-slide">
                <div class="card h-100 card-neo position-relative overflow-hidden">

                  <!-- Hover quick actions -->
                  <div class="position-absolute top-0 end-0 m-2 d-flex gap-1 z-3">
                    <button class="btn btn-sm btn-glass icon-chip share-card"
                            aria-label="{% trans 'Share' %}"
                            data-id="{{ car.id }}"
                            data-url="{% url 'car_detail' car.id %}"
                            data-bs-toggle="tooltip" title="{% trans 'Share' %}">
                      <i class="bi bi-share"></i>
                    </button>
                  </div>

                  <!-- Badges -->
                  <div class="position-absolute start-0 top-0 m-2 d-flex flex-wrap gap-1 z-3">
                    {% if car.is_new %}<span class="badge bg-primary text-white badge-modern new">{% trans "New" %}</span>{% endif %}
                    {% if car.is_certified %}<span class="badge bg-success badge-modern certified">{% trans "Certified" %}</span>{% endif %}
                    {% if car.is_hot %}<span class="badge bg-danger badge-modern hot">{% trans "Hot" %}</span>{% endif %}
                  </div>

                  <!-- Cover image -->
                  <img class="card-img-top car-img wf-skel"
                       src="{% if car.cover %}{{ car.cover.url }}{% else %}{% static 'img/sample1.jpg' %}{% endif %}"
                       alt="{{ car.title }}" style="aspect-ratio:16/10;object-fit:cover;" loading="lazy">

                  <div class="card-body">
                    <h5 class="card-title mb-1">{{ car.title }}</h5>

                    <!-- Tiny meta -->
                    <div class="small text-secondary mb-2 d-flex flex-wrap gap-2">
                      {% if car.make %}<span class="icon-chip"><i class="bi bi-buildings"></i>{{ car.make.name }}</span>{% endif %}
                      {% if car.body_type %}<span class="icon-chip"><i class="bi bi-truck"></i>{{ car.body_type.name }}</span>{% endif %}
                    </div>

                    <!-- Spec line -->
                    <p class="card-text small text-secondary mb-2">
                      {% if car.mileage %}{{ car.mileage|floatformat:0 }} {% trans "mi" %}{% else %}—{% endif %}
                      • {% if car.get_transmission_display %}{{ car.get_transmission_display }}{% else %}{% if car.transmission %}{% trans car.transmission %}{% else %}—{% endif %}{% endif %}
                      • {% if car.get_fuel_display %}{{ car.get_fuel_display }}{% else %}{% if car.fuel %}{% trans car.fuel %}{% else %}—{% endif %}{% endif %}
                    </p>

                    <!-- Dealer (optional) -->
                    {% if car.seller_name or car.seller_meta %}
                      <div class="d-flex align-items-center gap-2 small text-secondary mb-2">
                        <i class="bi bi-shop"></i>
                        <span class="text-truncate" title="{{ car.seller_name }} {{ car.seller_meta }}">
                          {{ car.seller_name|default:_("Dealer") }}{% if car.seller_meta %} • {{ car.seller_meta }}{% endif %}
                        </span>
                      </div>
                    {% endif %}

                    <!-- Price -->
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="price h5 mb-0">
                        {% if car.price %}${{ car.price|floatformat:0 }}{% else %}—{% endif %}
                      </div>
                      {% if car.price %}
                        <span class="badge text-bg-light border">{% trans "Est. payment" %}</span>
                      {% endif %}
                    </div>

                    <!-- Inline actions (moved inside .card-body) -->
                    <div class="card-actions d-flex gap-2 mt-2">
                      <form method="post" action="{% url 'cart_add' car_id=car.id %}" class="js-add-cart" data-pid="{{ car.id }}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-primary btn-icon" data-bs-toggle="tooltip" data-bs-title="{% trans 'Add to cart' %}">
                          <i class="bi bi-cart-plus"></i>
                        </button>
                      </form>

                      <form method="post" action="{% url 'cart_add' car.id %}" class="js-add-cart">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-primary btn-icon" data-bs-toggle="tooltip" data-bs-title="{% trans 'Compare' %}">
                          <i class="bi bi-plus-square"></i>
                        </button>
                      </form>

                      <a class="btn btn-sm btn-outline-primary btn-icon"
                         href="{% url 'test_drive' car.id %}"
                         data-bs-toggle="tooltip"
                         data-bs-title="{% trans 'Request A Test Drive' %}">
                        <i class="bi bi-car-front-fill"></i>
                      </a>
                    </div>
                  </div> <!-- /card-body -->

                  <div class="card-footer bg-white border-0">
                    <button class="btn btn-sm btn-outline-primary w-100 view-details"
                            data-bs-toggle="modal"
                            data-bs-target="#carDetailModal"
                            data-id="{{ car.id }}"
                            data-title="{{ car.title }}"
                            data-price="{{ car.price }}"
                            data-mileage="{{ car.mileage }}"
                            data-transmission="{{ car.transmission }}"
                            data-fuel="{{ car.fuel }}"
                            {% if car.make %}data-make="{{ car.make.name }}"{% endif %}
                            {% if car.model_name %}data-model="{{ car.model_name }}"{% endif %}
                            {% if car.body_type %}data-body="{{ car.body_type.name }}"{% endif %}
                            {% if car.overview %}data-overview="{{ car.overview|escapejs }}"{% endif %}
                            {% if car.history %}data-history="{{ car.history|escapejs }}"{% endif %}
                            {% if car.seller_name %}data-seller-name="{{ car.seller_name|escapejs }}"{% endif %}
                            {% if car.seller_meta %}data-seller-meta="{{ car.seller_meta|escapejs }}"{% endif %}
                            {% if car.cover %}data-cover="{{ car.cover.url }}"{% endif %}
                            data-images='[{% for img in car.images.all %}"{{ img.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}]'>
                      <i class="bi bi-eye me-1"></i> {% trans "View Details" %}
                    </button>
                  </div>

                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Pagination + arrows -->
          <div class="swiper-pagination mt-3"></div>
          <div class="swiper-button-prev" aria-label="Previous"></div>
          <div class="swiper-button-next" aria-label="Next"></div>
        </div>
      </div>

    {% else %}
      {# ===== Grid mode (4 or fewer) ===== #}
      <div class="row g-3 g-md-4">
        {% for car in featured_cars %}
        <div class="col-sm-6 col-lg-3">
          <div class="card h-100 card-neo position-relative overflow-hidden">

            <!-- Hover quick actions -->
            <div class="position-absolute top-0 end-0 m-2 d-flex gap-1 z-3">
              <button class="btn btn-sm btn-glass icon-chip share-card"
                      aria-label="{% trans 'Share' %}"
                      data-id="{{ car.id }}"
                      data-url="{% url 'car_detail' car.id %}"
                      data-bs-toggle="tooltip" title="{% trans 'Share' %}">
                <i class="bi bi-share"></i>
              </button>
            </div>

            <!-- Badges -->
            <div class="position-absolute start-0 top-0 m-2 d-flex flex-wrap gap-1 z-3">
              {% if car.is_new %}<span class="badge bg-primary text-white badge-modern new">{% trans "New" %}</span>{% endif %}
              {% if car.is_certified %}<span class="badge bg-success badge-modern certified">{% trans "Certified" %}</span>{% endif %}
              {% if car.is_hot %}<span class="badge bg-danger badge-modern hot">{% trans "Hot" %}</span>{% endif %}
            </div>

            <!-- Cover image -->
            <img class="card-img-top car-img wf-skel"
                 src="{% if car.cover %}{{ car.cover.url }}{% else %}{% static 'img/sample1.jpg' %}{% endif %}"
                 alt="{{ car.title }}" style="aspect-ratio:16/10;object-fit:cover;" loading="lazy">

            <div class="card-body">
              <h5 class="card-title mb-1">{{ car.title }}</h5>

              <!-- Tiny meta -->
              <div class="small text-secondary mb-2 d-flex flex-wrap gap-2">
                {% if car.make %}<span class="icon-chip"><i class="bi bi-buildings"></i>{{ car.make.name }}</span>{% endif %}
                {% if car.body_type %}<span class="icon-chip"><i class="bi bi-truck"></i>{{ car.body_type.name }}</span>{% endif %}
              </div>

              <!-- Spec line -->
              <p class="card-text small text-secondary mb-2">
                {% if car.mileage %}{{ car.mileage|floatformat:0 }} {% trans "mi" %}{% else %}—{% endif %}
                • {% if car.get_transmission_display %}{{ car.get_transmission_display }}{% else %}{% if car.transmission %}{% trans car.transmission %}{% else %}—{% endif %}{% endif %}
                • {% if car.get_fuel_display %}{{ car.get_fuel_display }}{% else %}{% if car.fuel %}{% trans car.fuel %}{% else %}—{% endif %}{% endif %}
              </p>

              <!-- Dealer (optional) -->
              {% if car.seller_name or car.seller_meta %}
                <div class="d-flex align-items-center gap-2 small text-secondary mb-2">
                  <i class="bi bi-shop"></i>
                  <span class="text-truncate" title="{{ car.seller_name }} {{ car.seller_meta }}">
                    {{ car.seller_name|default:_("Dealer") }}{% if car.seller_meta %} • {{ car.seller_meta }}{% endif %}
                  </span>
                </div>
              {% endif %}

              <!-- Price -->
              <div class="d-flex align-items-center justify-content-between">
                <div class="price h5 mb-0">
                  {% if car.price %}${{ car.price|floatformat:0 }}{% else %}—{% endif %}
                </div>
                {% if car.price %}
                  <span class="badge text-bg-light border">{% trans "Est. payment" %}</span>
                {% endif %}
              </div>

              <!-- Inline actions (moved inside .card-body) -->
              <div class="card-actions d-flex gap-2 mt-2">
                <form method="post" action="{% url 'cart_add' car_id=car.id %}" class="js-add-cart" data-pid="{{ car.id }}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-primary btn-icon" data-bs-toggle="tooltip" data-bs-title="{% trans 'Add to cart' %}">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </form>

                <form method="post" action="{% url 'cart_add' car.id %}" class="js-add-cart">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-primary btn-icon" data-bs-toggle="tooltip" data-bs-title="{% trans 'Compare' %}">
                    <i class="bi bi-plus-square"></i>
                  </button>
                </form>

                <a class="btn btn-sm btn-outline-primary btn-icon"
                   href="{% url 'test_drive' car.id %}"
                   data-bs-toggle="tooltip"
                   data-bs-title="{% trans 'Request A Test Drive' %}">
                  <i class="bi bi-car-front-fill"></i>
                </a>
              </div>
            </div> <!-- /card-body -->

            <div class="card-footer bg-white border-0">
              <button class="btn btn-sm btn-outline-primary w-100 view-details"
                      data-bs-toggle="modal"
                      data-bs-target="#carDetailModal"
                      data-id="{{ car.id }}"
                      data-title="{{ car.title }}"
                      data-price="{{ car.price }}"
                      data-mileage="{{ car.mileage }}"
                      data-transmission="{{ car.transmission }}"
                      data-fuel="{{ car.fuel }}"
                      {% if car.make %}data-make="{{ car.make.name }}"{% endif %}
                      {% if car.model_name %}data-model="{{ car.model_name }}"{% endif %}
                      {% if car.body_type %}data-body="{{ car.body_type.name }}"{% endif %}
                      {% if car.overview %}data-overview="{{ car.overview|escapejs }}"{% endif %}
                      {% if car.history %}data-history="{{ car.history|escapejs }}"{% endif %}
                      {% if car.seller_name %}data-seller-name="{{ car.seller_name|escapejs }}"{% endif %}
                      {% if car.seller_meta %}data-seller-meta="{{ car.seller_meta|escapejs }}"{% endif %}
                      {% if car.cover %}data-cover="{{ car.cover.url }}"{% endif %}
                      data-images='[{% for img in car.images.all %}"{{ img.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}]'>
                <i class="bi bi-eye me-1"></i> {% trans "View Details" %}
              </button>
            </div>

          </div>
        </div>
        {% empty %}
          <div class="col-12">
            <div class="alert alert-light border">{% trans "No featured cars yet." %}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>
</section>

<!-- ============================== LISTINGS (with sidebar filters) ============================== -->
<section class="py-5 border-top bg-white" id="results">
  <div class="container">

    <!-- Header: title + results count + controls -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div class="d-flex align-items-center gap-3">
        <h2 class="h4 mb-0">{% trans "All Listings" %}</h2>
        {% if page_obj %}
          <span class="badge text-bg-light border small">
            {% blocktrans with start=page_obj.start_index end=page_obj.end_index total=paginator.count %}Showing {{ start }}–{{ end }} of {{ total }} cars{% endblocktrans %}
          </span>
        {% endif %}
      </div>

      <div class="d-flex gap-2 align-items-center">
        <!-- Mobile Filters button -->
        <button class="btn btn-outline-secondary d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
          <i class="bi bi-sliders"></i> {% trans "Filters" %}
        </button>

        <!-- Sort -->
        <form id="sortForm" method="get" action="{% url 'home' %}#results">
          <!-- preserve existing filters on sort -->
          {% if q.min_price %}<input type="hidden" name="min_price" value="{{ q.min_price }}">{% endif %}
          {% if q.max_price %}<input type="hidden" name="max_price" value="{{ q.max_price }}">{% endif %}
          {% if q.make %}<input type="hidden" name="make" value="{{ q.make }}">{% endif %}
          {% for b in q.body_types %}<input type="hidden" name="body_types" value="{{ b }}">{% endfor %}
          {% if q.fuel %}<input type="hidden" name="fuel" value="{{ q.fuel }}">{% endif %}
          {% if q.transmission %}<input type="hidden" name="transmission" value="{{ q.transmission }}">{% endif %}
          {% if q.featured %}<input type="hidden" name="featured" value="{{ q.featured }}">{% endif %}

          <select class="form-select form-select-sm" style="width:auto" name="sort" id="sortSelect" onchange="this.form.submit()">
            <option value="-created" {% if sort == '-created' or not sort %}selected{% endif %}>{% trans "Sort: Newest" %}</option>
            <option value="price" {% if sort == 'price' %}selected{% endif %}>{% trans "Sort: Price (Low → High)" %}</option>
            <option value="-price" {% if sort == '-price' %}selected{% endif %}>{% trans "Sort: Price (High → Low)" %}</option>
            <option value="mileage" {% if sort == 'mileage' %}selected{% endif %}>{% trans "Sort: Mileage (Low → High)" %}</option>
          </select>
        </form>

        <!-- View switch -->
        <div class="btn-group" role="group" aria-label="{% trans 'View switch' %}">
          <input type="radio" class="btn-check" name="view" id="gridView" autocomplete="off" checked>
          <label class="btn btn-outline-secondary" for="gridView"><i class="bi bi-grid"></i></label>
          <input type="radio" class="btn-check" name="view" id="listView" autocomplete="off">
          <label class="btn btn-outline-secondary" for="listView"><i class="bi bi-list"></i></label>
        </div>
      </div>
    </div>

    <!-- Quick filters (extra) -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <a class="btn btn-sm btn-outline-dark rounded-pill"
         href="{% url 'home' %}?featured=1#results">
        <i class="bi bi-star-fill me-1"></i> {% trans "Featured" %}
      </a>
      <a class="btn btn-sm btn-outline-dark rounded-pill"
         href="{% url 'home' %}?fuel=Electric#results">
        <i class="bi bi-lightning-charge me-1"></i> {% trans "Electric" %}
      </a>
      <a class="btn btn-sm btn-outline-dark rounded-pill"
         href="{% url 'home' %}?max_price=20000#results">
        <i class="bi bi-cash-coin me-1"></i> {% trans "Under $20k" %}
      </a>
      <a class="btn btn-sm btn-outline-dark rounded-pill"
         href="{% url 'home' %}?transmission=Manual#results">
        <i class="bi bi-gear me-1"></i> {% trans "Manual" %}
      </a>
      <a class="btn btn-sm btn-outline-dark rounded-pill"
         href="{% url 'home' %}#results">
        {% trans "Reset" %}
      </a>
    </div>

    <!-- Active filter chips -->
    {% if q.min_price or q.max_price or q.make or q.body_types or q.fuel or q.transmission or q.featured %}
    <div class="d-flex flex-wrap gap-2 mb-3">
      {% if q.featured == '1' %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?min_price={{ q.min_price }}&max_price={{ q.max_price }}&make={{ q.make }}{% for b in q.body_types %}&body_types={{ b }}{% endfor %}&fuel={{ q.fuel }}&transmission={{ q.transmission }}#results">
          {% trans "Featured ×" %}
        </a>
      {% endif %}
      {% if q.min_price or q.max_price %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?make={{ q.make }}{% for b in q.body_types %}&body_types={{ b }}{% endfor %}&fuel={{ q.fuel }}&transmission={{ q.transmission }}{% if q.featured %}&featured={{ q.featured }}{% endif %}#results">
          {% blocktrans with min=q.min_price|default:"0" max=q.max_price|default:"∞" %}Price: {{ min }}–{{ max }} ×{% endblocktrans %}
        </a>
      {% endif %}
      {% if q.make %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?min_price={{ q.min_price }}&max_price={{ q.max_price }}{% for b in q.body_types %}&body_types={{ b }}{% endfor %}&fuel={{ q.fuel }}&transmission={{ q.transmission }}{% if q.featured %}&featured={{ q.featured }}{% endif %}#results">
          {% blocktrans with m=q.make %}Make: {{ m }} ×{% endblocktrans %}
        </a>
      {% endif %}
      {% for b in q.body_types %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?min_price={{ q.min_price }}&max_price={{ q.max_price }}&make={{ q.make }}{% for b2 in q.body_types %}{% if b2 != b %}&body_types={{ b2 }}{% endif %}{% endfor %}&fuel={{ q.fuel }}&transmission={{ q.transmission }}{% if q.featured %}&featured={{ q.featured }}{% endif %}#results">
          {% blocktrans with body=b %}Body: {{ body }} ×{% endblocktrans %}
        </a>
      {% endfor %}
      {% if q.fuel %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?min_price={{ q.min_price }}&max_price={{ q.max_price }}&make={{ q.make }}{% for b in q.body_types %}&body_types={{ b }}{% endfor %}&transmission={{ q.transmission }}{% if q.featured %}&featured={{ q.featured }}{% endif %}#results">
          {% trans "Fuel:" %} {% trans q.fuel %} ×
        </a>
      {% endif %}
      {% if q.transmission %}
        <a class="badge rounded-pill text-bg-light border text-decoration-none"
           href="{% url 'home' %}?min_price={{ q.min_price }}&max_price={{ q.max_price }}&make={{ q.make }}{% for b in q.body_types %}&body_types={{ b }}{% endfor %}&fuel={{ q.fuel }}{% if q.featured %}&featured={{ q.featured }}{% endif %}#results">
          {% trans "Trans:" %} {% trans q.transmission %} ×
        </a>
      {% endif %}
    </div>
    {% endif %}

    <div class="row g-4" id="resultsWrap">
      <!-- Sidebar (desktop) -->
      <aside class="col-lg-3 d-none d-lg-block">
        <div class="card bg-white text-dark shadow-sm">
          <div class="card-body text-dark">
            <h6 class="mb-3 text-dark">{% trans "Filters" %}</h6>
            <hr class="border-dark mb-3">

            <form id="filtersForm" class="text-dark" method="get" action="{% url 'home' %}#results">
              {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}

              <div class="mb-3 form-check">
                <input class="form-check-input" type="checkbox" id="featuredOnly" name="featured" value="1"
                       {% if q.featured == '1' %}checked{% endif %}>
                <label class="form-check-label text-dark" for="featuredOnly">{% trans "Featured only" %}</label>
              </div>

              <div class="mb-3">
                <label class="form-label text-dark">{% trans "Price range ($)" %}</label>
                <div class="d-flex gap-2">
                  <input type="number" class="form-control border-secondary text-dark bg-white"
                         name="min_price" placeholder="{% trans 'Min' %}" value="{{ q.min_price }}">
                  <input type="number" class="form-control border-secondary text-dark bg-white"
                         name="max_price" placeholder="{% trans 'Max' %}" value="{{ q.max_price }}">
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label text-dark">{% trans "Make" %}</label>
                <select class="form-select border-secondary bg-white text-dark" name="make">
                  <option value="">{% trans "Any" %}</option>
                  {% for make in makes %}
                    <option value="{{ make.slug }}" {% if q.make == make.slug %}selected{% endif %}>{{ make.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label text-dark">{% trans "Body type" %}</label>
                <div class="d-grid gap-2">
                  {% for body in body_types %}
                  <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           name="body_types"
                           value="{{ body.slug }}"
                           id="body_{{ body.slug }}"
                           {% if body.slug in q.body_types %}checked{% endif %}>
                    <label class="form-check-label text-dark" for="body_{{ body.slug }}">{{ body.name }}</label>
                  </div>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label text-dark">{% trans "Fuel" %}</label>
                <select class="form-select border-secondary bg-white text-dark" name="fuel">
                  <option value="">{% trans "Any" %}</option>
                  {% for code, label in fuel_choices %}
                    <option value="{{ code }}" {% if q.fuel == code %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label text-dark">{% trans "Transmission" %}</label>
                <select class="form-select border-secondary bg-white text-dark" name="transmission">
                  <option value="">{% trans "Any" %}</option>
                  {% for code, label in transmission_choices %}
                    <option value="{{ code }}" {% if q.transmission == code %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="d-grid gap-2">
                <button class="btn btn-primary" type="submit">{% trans "Apply filters" %}</button>
                <a class="btn btn-outline-secondary" href="{% url 'home' %}#results">{% trans "Clear all" %}</a>
              </div>
            </form>
          </div>
        </div>
      </aside>
      <!--RESULT-->
      <div class="col-lg-9" id="results">

        {# top meta row: count + optional sort #}
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
          <div class="small text-secondary">
            {% if is_paginated %}
              {{ paginator.count }} {% trans "results" %} • {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ paginator.num_pages }}
            {% else %}
              {{ cars|length }} {% trans "results" %}
            {% endif %}
          </div>
          {% if sort %}
            <div class="small text-secondary">{% trans "Sort" %}: <span class="fw-semibold">{{ sort }}</span></div>
          {% endif %}
        </div>

        <div class="row g-3 g-md-4" id="cardsGrid">
          {% for car in cars %}
          <div class="col-12 col-sm-6 col-xl-4">
            <div class="card h-100 wf-card position-relative">

              <!-- Ribbons -->
              <div class="position-absolute start-0 top-0 m-2 d-flex flex-wrap gap-1 z-3">
                {% if car.is_featured %}<span class="badge text-bg-warning">{% trans "Featured" %}</span>{% endif %}
                {% if car.is_new %}<span class="badge text-white badge-new">{% trans "New" %}</span>{% endif %}
                {% if car.is_hot %}<span class="badge text-white badge-hot">{% trans "Hot" %}</span>{% endif %}
              </div>

              <!-- Cover -->
              <img
                class="card-img-top car-img wf-skel"
                src="{% if car.cover %}{{ car.cover.url }}{% else %}{% static 'img/sample1.jpg' %}{% endif %}"
                alt="{{ car.title }}" loading="lazy">

              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-1 clamp-2">{{ car.title }}</h5>

                <!-- Meta line -->
                <div class="small text-secondary mb-2 d-flex flex-wrap gap-2">
                  {% if car.make %}<span class="chip"><i class="bi bi-buildings"></i>{{ car.make.name }}</span>{% endif %}
                  {% if car.body_type %}<span class="chip"><i class="bi bi-truck"></i>{{ car.body_type.name }}</span>{% endif %}
                </div>

                <!-- Specs -->
                <p class="card-text small text-secondary mb-3">
                  {% if car.mileage %}{{ car.mileage|floatformat:0 }} {% trans "mi" %}{% else %}—{% endif %}
                  • {% if car.get_transmission_display %}{{ car.get_transmission_display }}{% else %}{% if car.transmission %}{% trans car.transmission %}{% else %}—{% endif %}{% endif %}
                  • {% if car.get_fuel_display %}{{ car.get_fuel_display }}{% else %}{% if car.fuel %}{% trans car.fuel %}{% else %}—{% endif %}{% endif %}
                </p>

                <!-- Feature chips (derived) -->
                <div class="d-flex flex-wrap gap-1 mb-3">
                  {% if car.fuel == 'Electric' %}<span class="badge text-bg-light border"><i class="bi bi-lightning-charge me-1"></i>{% trans "EV" %}</span>{% endif %}
                  {% if car.transmission == 'Manual' %}<span class="badge text-bg-light border"><i class="bi bi-gear me-1"></i>{% trans "Manual" %}</span>{% endif %}
                  {% if car.is_certified %}<span class="badge text-bg-light border"><i class="bi bi-patch-check me-1"></i>{% trans "Certified" %}</span>{% endif %}
                </div>

                <!-- Price + quick actions -->
                <div class="mt-auto">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="price h5 mb-0">
                      {% if car.price %}${{ car.price|floatformat:0 }}{% else %}—{% endif %}
                    </div>
                    {% if car.price %}
                      <span class="badge text-bg-light border"
                            data-bs-toggle="tooltip"
                            title="{% trans 'Rough monthly estimate' %}">
                        {% trans "Est. payment" %}
                      </span>
                    {% endif %}
                  </div>

                  <div class="card-actions">

                    <!-- CART -->
                    <form method="post"
                          action="{% url 'cart_add' car_id=car.id %}"
                          class="js-add-cart"
                          data-pid="{{ car.id }}">
                      {% csrf_token %}
                      <button type="submit"
                              class="btn btn-sm btn-outline-primary btn-icon"
                              data-bs-toggle="tooltip"
                              data-bs-title="{% trans 'Add to cart' %}">
                        <i class="bi bi-cart-plus"></i>
                      </button>
                    </form>

                    <!-- Compare -->
                    <form method="post"
                          action="{% url 'cart_add' car.id %}"
                          class="js-add-cart">
                      {% csrf_token %}
                      <button type="submit"
                              class="btn btn-sm btn-outline-primary btn-icon"
                              data-bs-toggle="tooltip"
                              data-bs-title="{% trans 'Compare' %}"
                              aria-label="{% trans 'Compare' %}">
                        <i class="bi bi-plus-square"></i>
                      </button>
                    </form>

                    <!-- Share -->
                    <button type="button"
                            class="btn btn-sm btn-outline-primary btn-icon"
                            data-url="{% url 'car_detail' car.id %}"
                            data-bs-toggle="tooltip"
                            data-bs-title="{% trans 'Copy link' %}"
                            aria-label="{% trans 'Copy link' %}">
                      <i class="bi bi-share"></i>
                    </button>

                  </div>

                  <div class="d-grid mt-2">
                    <a href="{{ car.get_absolute_url|default:'#' }}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-eye me-1"></i> {% trans "View Details" %}
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% empty %}
          <div class="col-12">
            <div class="alert alert-light border">{% trans "No cars found." %}</div>
          </div>
          {% endfor %}
        </div>

        {# Pagination (no parentheses; no with/endwith) #}
        {% if is_paginated %}
        <nav class="mt-4" aria-label="{% trans 'Listings pagination' %}">
          <ul class="pagination justify-content-center">
            {# First + Prev #}
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page=1&sort={{ sort }}#results" aria-label="{% trans 'First' %}">&laquo;</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&sort={{ sort }}#results" aria-label="{% trans 'Prev' %}">{% trans "Prev" %}</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              <li class="page-item disabled"><span class="page-link">{% trans "Prev" %}</span></li>
            {% endif %}

            {# Page window with ellipses: 1,2 … (current-1,current,current+1) … n-1,n #}
            {% for num in paginator.page_range %}
              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}&sort={{ sort }}#results">{{ num }}</a>
              </li>
            {% endfor %}

            {# Next + Last #}
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&sort={{ sort }}#results" aria-label="{% trans 'Next' %}">{% trans "Next" %}</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ paginator.num_pages }}&sort={{ sort }}#results" aria-label="{% trans 'Last' %}">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>


    </div>
  </div>
</section>


<!-- ============================== COMPARE DRAWER ============================== -->
<div class="sticky-compare bg-white border-top p-2">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2" id="compareThumbs"></div>
    <div class="d-flex align-items-center gap-2">
      <small class="text-secondary" id="compareHint">{% trans "Select up to 4 to compare" %}</small>
      <button class="btn btn-outline-secondary" id="clearCompare">{% trans "Clear" %}</button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#compareModal" id="openCompare" disabled>{% trans "Compare Now" %}</button>
    </div>
  </div>
</div>

<!-- ============================== OFFCANVAS FILTERS (mobile) ============================== -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">{% trans "Filters" %}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% trans 'Close' %}"></button>
  </div>
  <div class="offcanvas-body">
    <form id="filtersFormMobile">
      <div class="mb-3">
        <label class="form-label">{% trans "Price range ($)" %}</label>
        <div class="d-flex gap-2">
          <input class="form-control" name="min_price" placeholder="{% trans 'Min' %}" />
          <input class="form-control" name="max_price" placeholder="{% trans 'Max' %}" />
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">{% trans "Make" %}</label>
        <select class="form-select" name="make">
          <option value="">{% trans "Any" %}</option>
          {% for make in makes %}
            <option value="{{ make.slug }}">{{ make.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">{% trans "Body type" %}</label>
        <div class="d-grid gap-2">
          {% for body in body_types %}
          <label class="form-check">
            <input class="form-check-input" type="checkbox" name="body_types" value="{{ body.slug }}">
            <span class="form-check-label">{{ body.name }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">{% trans "Fuel" %}</label>
        <select class="form-select" name="fuel">
          <option value="">{% trans "Any" %}</option>
          <option>{% trans "Petrol" %}</option><option>{% trans "Diesel" %}</option><option>{% trans "Hybrid" %}</option><option>{% trans "Electric" %}</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">{% trans "Transmission" %}</label>
        <select class="form-select" name="transmission">
          <option value="">{% trans "Any" %}</option>
          <option>{% trans "Automatic" %}</option><option>{% trans "Manual" %}</option><option>{% trans "CVT" %}</option>
        </select>
      </div>
      <button class="btn btn-primary w-100" data-bs-dismiss="offcanvas" type="submit">{% trans "Apply filters" %}</button>
    </form>
  </div>
</div>


<!-- ============================== COMPARE MODAL ============================== -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Compare Vehicles" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table align-middle" id="compareTable">
            <thead>
              <tr>
                <th>{% trans "Spec" %}</th>
                <th>{% trans "Vehicle 1" %}</th>
                <th>{% trans "Vehicle 2" %}</th>
                <th>{% trans "Vehicle 3" %}</th>
                <th>{% trans "Vehicle 4" %}</th>
              </tr>
            </thead>
            <tbody class="small text-secondary">
              <tr><td>{% trans "Price" %}</td><td data-spec="price-1">—</td><td data-spec="price-2">—</td><td data-spec="price-3">—</td><td data-spec="price-4">—</td></tr>
              <tr><td>{% trans "Mileage" %}</td><td data-spec="mileage-1">—</td><td data-spec="mileage-2">—</td><td data-spec="mileage-3">—</td><td data-spec="mileage-4">—</td></tr>
              <tr><td>{% trans "Fuel" %}</td><td data-spec="fuel-1">—</td><td data-spec="fuel-2">—</td><td data-spec="fuel-3">—</td><td data-spec="fuel-4">—</td></tr>
              <tr><td>{% trans "Transmission" %}</td><td data-spec="trans-1">—</td><td data-spec="trans-2">—</td><td data-spec="trans-3">—</td><td data-spec="trans-4">—</td></tr>
              <tr><td>{% trans "Body" %}</td><td data-spec="body-1">—</td><td data-spec="body-2">—</td><td data-spec="body-3">—</td><td data-spec="body-4">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button class="btn btn-primary" id="saveComparison">{% trans "Save Comparison" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- ============================== SELL MODAL ============================== -->
<div class="modal fade" id="sellModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Sell your car" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <p class="text-secondary small">{% trans "Create a free listing in minutes. Add photos, set a price, and reach verified buyers." %}</p>
        <form class="row g-2" id="sellForm">
          <div class="col-md-6"><input class="form-control" name="make" placeholder="{% trans 'Make' %}" /></div>
          <div class="col-md-6"><input class="form-control" name="model" placeholder="{% trans 'Model' %}" /></div>
          <div class="col-md-6"><input class="form-control" name="year" placeholder="{% trans 'Year' %}" /></div>
          <div class="col-md-6"><input class="form-control" name="mileage" placeholder="{% trans 'Mileage' %}" /></div>
          <div class="col-12"><input class="form-control" name="email" placeholder="{% trans 'Your email' %}" /></div>
          <div class="col-12"><button class="btn btn-primary w-100" type="button" id="startListingBtn">{% trans "Start Listing" %}</button></div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ============================== FINANCE CALCULATOR MODAL ============================== -->
<div class="modal fade" id="financeCalcModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Quick Finance Calculator" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <!-- IMPORTANT: method=get and action to the new route -->
        <form id="quickCalcForm" method="get" action="{% url 'finance_offers' %}">
          <div class="mb-2">
            <label class="form-label">{% trans "Vehicle Price ($)" %}</label>
            <input class="form-control" id="qPrice" name="qPrice" type="number" value="17990" required>
          </div>
          <div class="mb-2">
            <label class="form-label">{% trans "Down Payment ($)" %}</label>
            <input class="form-control" id="qDown" name="qDown" type="number" value="3000" min="0">
          </div>
          <div class="mb-2">
            <label class="form-label">{% trans "APR %" %}</label>
            <input class="form-control" id="qApr" name="qApr" type="number" value="6" step="0.01" min="0">
          </div>
          <div class="mb-3">
            <label class="form-label">{% trans "Term (months)" %}</label>
            <input class="form-range" id="qTerm" name="qTerm" type="range" min="12" max="84" value="60">
            <div class="d-flex justify-content-between"><small>12</small><small>84</small></div>
          </div>

          <!-- Live preview (optional) -->
          <div class="alert alert-light border">{% trans "Monthly:" %} <strong id="qMonthly">$0</strong></div>

          <button class="btn btn-primary w-100" type="submit">{% trans "See Offers" %}</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
